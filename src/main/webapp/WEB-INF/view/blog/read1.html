<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>

		<!--bootstrap-->
		<link rel="stylesheet" href="../bootstrap/css/bootstrap.css" />

		<!-- 第三方 -->
		<link rel="stylesheet" href="../css/clock/clock.css" />
		<link rel="stylesheet" href="../css/popup/popup.css" />

		<!--自定义-->
		<link rel="stylesheet" href="../css/blog/style1.css" />
		<link rel="stylesheet" href="../css/blog/read1.css" />
	</head>

	<body>
		<div class="container">
			<div class="header">
				<div class="blogTitle">
					<h1>
						<a id="headTitle" href=""></a>
					</h1>
				</div>
				<div class="navigation">
					<ul id="navList">
						<li>
							<a id="mainhome" href="javascript:void(0)">林区</a>
						</li>
						<li>
							<a id="myhome" href="javascript:void(0)">首页</a>
						</li>
						<li>
							<a id="newartical" href="javascript:void(0)">新博客</a>
						</li>
						<li>
							<a id="contact" href="javascript:void(0)">联系</a>
						</li>
						<li>
							<a id="manage" href="javascript:void(0)">管理</a>
						</li>
						<li>
							<a id="draft" href="javascript:void(0)">草稿箱</a>
						</li>
					</ul>
				</div>
			</div>

			<div class="main">
				<div class="content">
					<div class="read">
						<div class="first">
							<a href="">文章一</a><br>
							<span></span>
							<a class="edit" href="javascript:void(0);">编辑</a>
							<a class="collect" href="javascript:void(0);">收藏</a>
							<a class="quality" href="javascript:void(0);">申精</a>
						</div>
						<div class="second">
						</div>
					</div>

					<div id="commentList">
						<div class="commentTop">
							<span>评论列表</span>
						</div>
						<div id="allComment">
							<!-- <div class="oneComment">
								<div>
									<a href="#lou_1" name="lou_1">#1楼</a>
									<span>2018-02-08 09:49 |</span>
									<span class="hidden">1</span>
									<a href="javascript:void(0);" class="commentUser">大个子</a>
								</div>
								<p>
									123456789
								</p>
							</div>
							<div class="oneComment">
								<div>
									<a href="#lou_2" name="lou_2">#2楼</a>
									<span>2018-02-08 09:50 |</span>
									<span class="hidden">2</span>
									<a href="javascript:void(0);" class="commentUser">小个子</a>
								</div>
								<p>
									123456789
								</p>
							</div> -->
						</div>
						<div id="pager_bottom" style="margin-left: 20px;">
							<nav aria-label="Page navigation">
								<ul class="pagination">
									<li id="firstli">
										<a href="javascript:void(0);" onclick="">&laquo;</a>
									</li>
									<li id="lastli">
										<a href="javascript:void(0);" onclick="">&raquo;</a>
									</li>
								</ul>
							</nav>
						</div>
					</div>

					<div id="commentWrite">
						<div class="commentTop">
							<span>发表评论</span>
						</div>
						<div id="writeComment">
							<span>昵称：</span>
							<span id="commentUser">..</span>
							<span style="display: block; margin-top: 5px;"><span>评论内容：</span><span class="count hide">已经输入<span>0</span>字</span>
							</span>
							<textarea rows="12" cols="20" id="textarea" class="form-control" style="width: 400px;" oninput="$wordCount()"></textarea>
							<button type="submit" style="margin-top: 5px;" class="btn btn-primary " id="submit">提交评论</button>
							<button type="reset" style="margin-top: 5px;" class="btn btn-primary " id="reset">清空</button>
						</div>
						<div id="notComment" class="hide">
							<span>只有注册用户可以评论。请</span>
							<a href="javascript:void(0)" onclick="goLogin()">登录</a><span>来访问网站。</span>
						</div>
					</div>
				</div>
				<div class="side">
					<div class="userItem">
						<h3 class="itemTitle">博主信息</h3>
						<div id="userItemInfo">
							昵称：
							<a id="nick" href="javascript:void(0)"></a><br> 博龄：
							<a id="garAge" href="javascript:void(0)" title=""></a><br> 粉丝：
							<a id="fan" href="javascript:void(0)"></a><br> 关注：
							<a id="follow" href="javascript:void(0)"></a><br>
							<a id="addFollow" href="javascript:void(0)">+加关注</a>
						</div>
					</div>
					<div class="calendar">
						<h3 class="itemTitle">时间</h3>
						<div id="hoverclock"></div>
					</div>
					<!-- <div class="articalFile">
						<h3 class="itemTitle">文章档案</h3>
						<div id="articalFileNav">
							<ul>
								<li>
									<a href="javascript:void(0)">2017年7月 (1)</a>
								</li>
							</ul>
						</div>
					</div> -->
				</div>
			</div>

			<div class="footer">©2017 小叶子</div>
		</div>
		
		
		<!-- 申精模态框 -->
		<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<!--主体-->
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
							<h4 class="modal-title" id="myModalLabel">博客申精窗口</h4>
						</div>
						<!-- 主体-->
						<div class="modal-body">
							<label>请输入你的申精理由：</label>
							<textarea rows="5" cols="80" class="form-control" id="reason"></textarea>
						</div>
						<!--脚注 -->
						<div class="modal-footer">
							<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
							<button type="button" class="btn btn-primary" id="apply_submit">提交</button>
						</div>
					</div>
				</div>
		</div>

		<!-- bootstrap、juqery -->
		<script type="text/javascript" src="../js/jquery.js"></script>
		<script type="text/javascript" src="../bootstrap/js/bootstrap.js"></script>
		<script type="text/javascript" src="../js/jquery.tmpl.js"></script>

		<!-- 第三方 -->
		<script type="text/javascript" src="../js/clock/clock.js"></script>
		<script type="text/javascript" src="../js/popup/popup.js"></script>

		<!-- 自定义 -->
		<script type="text/javascript" src="../js/blog/blogportal.js"></script>
		<script type="text/javascript" src="../js/pages.js"></script>
		
		<script type="text/x-jquery-tmpl" id="t1">
							<div class="oneComment">
								<div>
									<a href="#lou_${floor}" name="lou_${floor}">#${floor}楼</a>
									<span>${dateFormat(createTime)} |</span>
									<span class="hidden">${user.id}</span>
									<a href="javascript:void(0);" class="commentUser">${user.nickname}</a>
								</div>
								<p>
									${content}
								</p>
							</div>
		</script>
		
		<script type="text/javascript">
			/*自定义分页的必备参数*/
			var currentPage = 1;
			var totalPage = 30;

			/*准备工作*/
			//时钟
			$("#hoverclock").hoverclock({
				"h_width": 200,
				"h_height": 200,
				//"h_hourNumSize": "80",
				// "h_hourNumRadii": "200",
				// "h_hourNumShow": false,
				// "h_minuteNumShow":false,
				"h_hourNumColor": "deeppink",
				"h_backColor": "white",
				//"h_borderColor": "gold",
				//"h_frontColor":"red",
				"h_linkText": dateFormatClock()
			});
			
			function dateFormatClock() {
				var date = new Date();

				var str = "";
				str += date.getFullYear() + "-";
				if(date.getMonth() + 1 < 10) {
					str += "0" + (date.getMonth() + 1) + "-";
				} else {
					str += (date.getMonth() + 1) + "-";
				}
				if(date.getDate() < 10) {
					str += "0" + date.getDate();
				} else {
					str += date.getDate();
				}
				return str;
			}

			//转换时间
			function dateFormat(time) {
				var date = new Date(time);

				var str = "";
				str += date.getFullYear() + "-";
				if(date.getMonth() + 1 < 10) {
					str += "0" + (date.getMonth() + 1) + "-";
				} else {
					str += (date.getMonth() + 1) + "-";
				}
				if(date.getDate() < 10) {
					str += "0" + date.getDate();
				} else {
					str += date.getDate();
				}
				return str;
			}

			//url取参
			var $getQueryString = function(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
				var r = window.parent.location.search.substr(1).match(reg);
				if(r != null)
					return unescape(r[2]);
				return null;
			}

			/*文章逻辑*/
			var aid;
			//主体显示
			$(function(){
				aid = $getQueryString("aid");
				$getOneArtical(aid);
			});
			
			//获取一篇博客
			var $getOneArtical = function(aid){
				$.ajax({
					type : "get",
					url : "../getOneArtical",
					dataType : "json",
					data : {
						aid : aid
					},
					async : true,
					success : function(data) {
						console.log(data);
						$(".first a:eq(0)").text(data.title);
						$(".first span").text("Posted on "+dateFormat(data.leaveTime)+" "+data.user.nickname+" 阅读("+data.viewNum+") 评论("+data.commentNum+") ")
						
						var rurl = "";
						var file = "";
						
						if(data.reprint != ""){
							rurl = "转载自：<a target='_blank' href="+data.reprint+">"+data.reprint+"</a></br></br>" ;
						}
						if(data.file != null){
							var name = data.file.filename+"."+data.file.filestyle;
							file = "</br></br>随博文件：<a href='ftp://yezi:123456@106.15.229.200/file/"+name+"' target='_blank'>"+name+"</a>"; 
						}
						
						
						$(".second").html(rurl+data.contentRich+file);
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			}
			
			//跳转编辑文章（验明身份）
			$(".edit").click(function() {
				$.ajax({
					type : "post",
					url : "../verEditBlog",
					dataType : "json",
					data : {
						uid : uid
					},
					async : true,
					success : function(data) {
						console.log(data);
						if(data == 1){
							jqalert({
								title: '提示弹窗',
								cont: '请先登录！'
							});
						} else if(data == 2){
							jqalert({
								title: '提示弹窗',
								cont: '您不是作者，无权编辑！'
							});
						} else if(data == 3){
							window.parent.location.href = "../blogHandle?aid="+aid;								
						}
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			});

			//收藏文章（验明身份）
			$(".collect").click(function() {
				$.ajax({
					type : "post",
					url : "../collectOneBlog",
					dataType : "json",
					data : {
						aid : aid,
						uid : uid
					},
					async : true,
					success : function(data) {
						console.log(data);
						if(data == 1){
							jqalert({
								title: '提示弹窗',
								cont: '请登录再收藏！'
							});
						} else if(data == 2){
							jqalert({
								title: '提示弹窗',
								cont: '请不要收藏自己的博客！'
							});
						} else if(data == 3){
							jqalert({
								title: '提示弹窗',
								cont: '收藏成功！'
							});
						}
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			});
			
			// 申精验明身份
			$(".quality").click(function() {
				$.ajax({
					type : "post",
					url : "../verEditBlog",
					dataType : "json",
					data : {
						uid : uid
					},
					async : true,
					success : function(data) {
						console.log(data);
						if(data == 1){
							jqalert({
								title: '提示弹窗',
								cont: '请先登录！！'
							});
						} else if(data == 2){
							jqalert({
								title: '提示弹窗',
								cont: '您不是作者，无权申精！'
							});
						} else if(data == 3){
							$('#myModal').modal('show');
						}
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			});
			
			
			// 申精提交
			$("#apply_submit").click(function() {
				var reason = $.trim($("#reason").val());
				if(reason != ""){
					$.ajax({
						type : "post",
						url : "../blogQuality",
						dataType : "json",
						data : {
							aid : aid,
							reason : reason
						},
						async : true,
						success : function(data) {
							console.log(data);
							if(data){
								window.location.reload();
							}else{
								jqalert({
									title: '提示弹窗',
									cont: '申请提交失败！！'
								});
							}
						},
						error : function() {
							alert("数据获取失败");
						}
					});
				}else{
					alert("请输入理由！！！");					
				}
			});

			/*评论逻辑*/
			//评论列表
			$(function(){
				$getPageItems(currentPage, aid);
			});
			
			var $getPageItems = function(current,aid){
				$.ajax({
					type : "get",
					url : "../getBlogComments",
					dataType : "json",
					data : {
						current : current,
						aid : aid
					},
					async : true,
					success : function(data) {
						console.log(data);
						if(data.totalPages == 0){
							$("#allComment").text("暂未有评论");
						} else{
							$("#t1").tmpl(data.oList).appendTo("#allComment");
							totalPage = data.totalPages;
							$getPages();
						}
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			}
			
			/*自定义分页的逻辑*/
			$(function() {

				$(document).on(
						"click",
						".pagination li",
						function() {
							var current = $.trim($(this).text());
							if (current == "«") {
								var temp = $.trim($(".pagination li.active").prev()
										.text());
								if (temp != "«") {
									var $a = $(".pagination li.active");
									$(".pagination li.active")
											.removeClass("active");
									$a.prev().addClass("active");
									currentPage = parseInt($.trim($(
											".pagination li.active").text()));
									$(".page_item").remove();
									//$getPages();
									$("#allComment").empty();
									$getPageItems(currentPage,aid);
								}
							} else if (current == "»") {
								var temp = $.trim($(".pagination li.active").next()
										.text());
								if (temp != "»") {
									var $a = $(".pagination li.active");
									$(".pagination li.active")
											.removeClass("active");
									$a.next().addClass("active");
									currentPage = parseInt($.trim($(
											".pagination li.active").text()));
									$(".page_item").remove();
									//$getPages();
									$("#allComment").empty();
									$getPageItems(currentPage,aid);
								}
							} else if (current == "...") {

							} else {
								$(this).siblings("li").removeClass("active");
								$(this).addClass("active");
								currentPage = parseInt($.trim($(
										".pagination li.active").text()));
								$(".page_item").remove();
								//$getPages();
								$("#allComment").empty();
								$getPageItems(currentPage,aid);
							}
						});

			});
			
			//跳转评论人首页
			$(document).on('click',".commentUser",function() {
				var userId = $(this).prev().text();
				window.parent.location.href = "../userinfo?id="+userId;
			});

			/*写评论逻辑*/
			$(function(){
				$getCommenter();
			});
			
			var $getCommenter = function(){
				$.ajax({
					type : "get",
					url : "../getCommenter",
					dataType : "json",
					async : true,
					success : function(data) {
						console.log(data);
						if(data.str == null){
							$("#writeComment").addClass("hide");
							$("#notComment").removeClass("hide");
						}else{
							$("#commentUser").text(data.str);
						}
						
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			}
			
			function goLogin(){
				window.parent.location.href = "../loginForm";
			}
			
			
			//评论计数
			var $wordCount = function() {
				$(".count").removeClass("hide");
				var count = $("textarea").val().length;
				if(count == 0) {
					$(".count").addClass("hide");
				}
				$(".count span").text(count);
			}

			//提交
			$("#submit").click(function() {
				var count = $("textarea").val().length;
				if(count == 0) {
					jqalert({
						title: '提示弹窗',
						cont: '评论不得为空'
					});
				} else if(count > 140) {
					jqalert({
						title: '提示弹窗',
						cont: '评论不得超过140字'
					});
				} else {
					jqalert({
						title: '确认弹窗',
						cont: '您是否确认提交评论',
						yestext: '确定',
						notext: '取消',
						yesfn: function() {
							var content = $("textarea").val();
							$writeOneComment(aid, content);
						},
						nofn: function() {
						}
					});
				}

			});
			
			//提交交互
			var $writeOneComment = function(aid,content){
				$.ajax({
					type : "post",
					url : "../writeOneComment",
					dataType : "json",
					data : {
						aid : aid,
						content : content
					},
					async : true,
					success : function(data) {
						console.log(data);
						if(data){
							window.location.reload();
						}
					},
					error : function() {
						alert("数据获取失败");
					}
				});
			}

			//清空
			$("#reset").click(function() {
				jqalert({
					title: '确认弹窗',
					cont: '您是否确认清空评论',
					yestext: '确定',
					notext: '取消',
					yesfn: function() {
						$("textarea").val("");
						$(".count").addClass("hide");
					},
					nofn: function() {
					}
				});
			});
			
			

		</script>
	</body>

</html>